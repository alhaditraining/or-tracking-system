@implements IDisposable

@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<MudNavMenu>
    <AuthorizeView Policy="ViewerOrAdmin">
        <Authorized>
            <MudNavGroup Title="Reports" Icon="@Icons.Material.Filled.Assessment" Expanded="true">
                <MudNavLink Href="reports/dashboard" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                <MudNavLink Href="reports/ors" Icon="@Icons.Material.Filled.AccountBalance">OR Reports</MudNavLink>
                <MudNavLink Href="reports/invoices" Icon="@Icons.Material.Filled.Receipt">Invoice Reports</MudNavLink>
                <MudNavLink Href="reports/stationery" Icon="@Icons.Material.Filled.Edit">Stationery Reports</MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Policy="AdminOnly">
        <Authorized>
            <MudDivider Class="my-2" />
            <MudNavGroup Title="Administration" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="true">
                <MudNavLink Href="admin/users" Icon="@Icons.Material.Filled.People">User Management</MudNavLink>
                <MudNavLink Href="admin/contract-contexts" Icon="@Icons.Material.Filled.Description">Contract Contexts</MudNavLink>
                <MudNavLink Href="admin/ors" Icon="@Icons.Material.Filled.AccountBalance">ORs</MudNavLink>
                <MudNavLink Href="admin/requests" Icon="@Icons.Material.Filled.Assignment">LM Requests</MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView>
        <Authorized>
            <MudDivider Class="my-2" />
            <MudNavLink Href="Account/Manage" Icon="@Icons.Material.Filled.Person">Account</MudNavLink>
            <MudNavLink OnClick="@OnLogoutClick" Icon="@Icons.Material.Filled.Logout">Logout</MudNavLink>
        </Authorized>
        <NotAuthorized>
            <MudDivider Class="my-2" />
            <MudNavLink Href="Account/Login" Icon="@Icons.Material.Filled.Login">Login</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

<form id="logoutForm" action="/Account/Logout" method="post" style="display: none;">
    <AntiforgeryToken />
    <input type="hidden" name="ReturnUrl" value="@currentUrl" />
</form>

@code {
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private async Task OnLogoutClick()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("submitLogoutForm");
        }
        catch
        {
            // Fallback: navigate directly to logout when JS Interop is unavailable (e.g., static SSR mode)
            NavigationManager.NavigateTo("/Account/Logout", forceLoad: true);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
