@page "/admin/ors"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using ORTrackingSystem.Data
@using ORTrackingSystem.Models
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Policy = "AdminOnly")]
@rendermode InteractiveServer

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>ORs</PageTitle>

<h1>ORs (OPS / BS)</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowCreateForm">
        <span class="bi bi-plus-circle"></span> Create New OR
    </button>
</div>

@if (ShowForm && EditingOR != null)
{
    <div class="card mb-4">
        <div class="card-header">
            <h3>@(EditingOR.Id > 0 ? "Edit" : "Create") OR</h3>
        </div>
        <div class="card-body">
            <EditForm Model="EditingOR" OnValidSubmit="SaveOR" FormName="orForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">OR Number</label>
                        <InputText @bind-Value="EditingOR.ORNumber" class="form-control" />
                        <ValidationMessage For="() => EditingOR!.ORNumber" />
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contract Context</label>
                        <InputSelect @bind-Value="EditingOR.ContractContextId" class="form-control">
                            <option value="0">-- Select Contract Context --</option>
                            @foreach (var context in ContractContextsList)
                            {
                                <option value="@context.Id">@context.ContractName</option>
                            }
                        </InputSelect>
                        @if (EditingOR.ContractContextId == 0)
                        {
                            <div class="text-danger">Contract Context is required</div>
                        }
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Budget Type</label>
                        <InputSelect @bind-Value="EditingOR.BudgetType" class="form-control">
                            <option value="@BudgetType.OPS">OPS</option>
                            <option value="@BudgetType.BS">BS</option>
                        </InputSelect>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Total Value</label>
                        <InputNumber @bind-Value="EditingOR.TotalValue" class="form-control" />
                        <ValidationMessage For="() => EditingOR!.TotalValue" />
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="EditingOR.Status" class="form-control">
                            <option value="@ORStatus.Open">Open</option>
                            <option value="@ORStatus.Closed">Closed</option>
                        </InputSelect>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success" disabled="@(EditingOR.ContractContextId == 0)">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert @StatusClass" role="alert">
        @StatusMessage
    </div>
}

<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>OR Number</th>
            <th>Contract Context</th>
            <th>Budget Type</th>
            <th>Total Value</th>
            <th>Status</th>
            <th>Created Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var or in ORsList)
        {
            <tr>
                <td>@or.Id</td>
                <td>@or.ORNumber</td>
                <td>@or.ContractContext.ContractName</td>
                <td>@or.BudgetType</td>
                <td>@or.TotalValue.ToString("C")</td>
                <td>
                    <span class="badge @(or.Status == ORStatus.Open ? "bg-success" : "bg-secondary")">
                        @or.Status
                    </span>
                </td>
                <td>@or.CreatedDate.ToString("yyyy-MM-dd")</td>
                <td>
                    <button class="btn btn-sm btn-primary" @onclick="() => EditOR(or)">Edit</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private List<OR> ORsList = new();
    private List<ContractContext> ContractContextsList = new();
    private ORFormModel? EditingOR;
    private bool ShowForm = false;
    private string StatusMessage = "";
    private string StatusClass = "";
    private string? CurrentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        CurrentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        
        await LoadContractContexts();
        await LoadORs();
    }

    private async Task LoadContractContexts()
    {
        ContractContextsList = await DbContext.ContractContexts
            .OrderBy(c => c.ContractName)
            .ToListAsync();
    }

    private async Task LoadORs()
    {
        ORsList = await DbContext.ORs
            .Include(o => o.ContractContext)
            .OrderByDescending(o => o.CreatedDate)
            .ToListAsync();
    }

    private void ShowCreateForm()
    {
        EditingOR = new ORFormModel
        {
            BudgetType = BudgetType.OPS,
            Status = ORStatus.Open
        };
        ShowForm = true;
        StatusMessage = "";
    }

    private void EditOR(OR or)
    {
        EditingOR = new ORFormModel
        {
            Id = or.Id,
            ORNumber = or.ORNumber,
            ContractContextId = or.ContractContextId,
            BudgetType = or.BudgetType,
            TotalValue = or.TotalValue,
            Status = or.Status
        };
        ShowForm = true;
        StatusMessage = "";
    }

    private void CancelEdit()
    {
        ShowForm = false;
        EditingOR = null;
        StatusMessage = "";
    }

    private async Task SaveOR()
    {
        if (EditingOR == null) return;
        
        if (EditingOR.ContractContextId == 0)
        {
            StatusMessage = "Please select a Contract Context.";
            StatusClass = "alert-danger";
            return;
        }

        try
        {
            if (EditingOR.Id == 0)
            {
                // Create new
                var newOR = new OR
                {
                    ORNumber = EditingOR.ORNumber,
                    ContractContextId = EditingOR.ContractContextId,
                    BudgetType = EditingOR.BudgetType,
                    TotalValue = EditingOR.TotalValue,
                    Status = EditingOR.Status,
                    CreatedDate = DateTime.UtcNow,
                    CreatedByUserId = CurrentUserId ?? "unknown"
                };
                DbContext.ORs.Add(newOR);
            }
            else
            {
                // Update existing
                var existingOR = await DbContext.ORs.FindAsync(EditingOR.Id);
                if (existingOR != null)
                {
                    existingOR.ORNumber = EditingOR.ORNumber;
                    existingOR.ContractContextId = EditingOR.ContractContextId;
                    existingOR.BudgetType = EditingOR.BudgetType;
                    existingOR.TotalValue = EditingOR.TotalValue;
                    existingOR.Status = EditingOR.Status;
                }
            }

            await DbContext.SaveChangesAsync();
            
            StatusMessage = EditingOR.Id == 0 
                ? "OR created successfully."
                : "OR updated successfully.";
            StatusClass = "alert-success";
            
            ShowForm = false;
            EditingOR = null;
            await LoadORs();
        }
        catch (DbUpdateException ex)
        {
            if (ex.InnerException?.Message.Contains("IX_ORs_ORNumber") ?? false)
            {
                StatusMessage = "Error: An OR with this OR Number already exists.";
            }
            else
            {
                StatusMessage = $"Error saving OR: {ex.Message}";
            }
            StatusClass = "alert-danger";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error saving OR: {ex.Message}";
            StatusClass = "alert-danger";
        }
    }

    public class ORFormModel
    {
        public int Id { get; set; }

        [Required]
        [MaxLength(100)]
        public string ORNumber { get; set; } = string.Empty;

        public int ContractContextId { get; set; }

        public BudgetType BudgetType { get; set; }

        public ORStatus Status { get; set; } = ORStatus.Open;

        public decimal TotalValue { get; set; }
    }
}
