@page "/reports/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using ORTrackingSystem.Data
@using ORTrackingSystem.Models
@using ORTrackingSystem.Models.ViewModels
@attribute [Authorize(Policy = "ViewerOrAdmin")]
@rendermode InteractiveServer

@inject ApplicationDbContext DbContext

<PageTitle>Reports Dashboard</PageTitle>

<h1>Reports Dashboard</h1>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-12">
            <h3>Overall Metrics</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Total ORs</h5>
                            <p class="card-text display-6">@dashboard.Total.TotalORs</p>
                            <small class="text-muted">Open: @dashboard.Total.OpenORs | Closed: @dashboard.Total.ClosedORs</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Total OR Value</h5>
                            <p class="card-text display-6">@dashboard.Total.TotalORValue.ToString("C")</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Total Invoiced</h5>
                            <p class="card-text display-6">@dashboard.Total.TotalInvoicedAmount.ToString("C")</p>
                            <small class="text-muted">Paid: @dashboard.Total.PaidInvoicesTotal.ToString("C")</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Remaining</h5>
                            <p class="card-text display-6">@dashboard.Total.RemainingAmount.ToString("C")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">OPS Budget</h4>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th>Total ORs:</th>
                                <td>@dashboard.OPS.TotalORs</td>
                            </tr>
                            <tr>
                                <th>Open ORs:</th>
                                <td>@dashboard.OPS.OpenORs</td>
                            </tr>
                            <tr>
                                <th>Closed ORs:</th>
                                <td>@dashboard.OPS.ClosedORs</td>
                            </tr>
                            <tr>
                                <th>Total Value:</th>
                                <td>@dashboard.OPS.TotalORValue.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Invoiced Amount:</th>
                                <td>@dashboard.OPS.TotalInvoicedAmount.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Remaining:</th>
                                <td>@dashboard.OPS.RemainingAmount.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Paid Invoices:</th>
                                <td>@dashboard.OPS.PaidInvoicesTotal.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Unpaid Invoices:</th>
                                <td>@dashboard.OPS.UnpaidInvoicesTotal.ToString("C")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">BS Budget</h4>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th>Total ORs:</th>
                                <td>@dashboard.BS.TotalORs</td>
                            </tr>
                            <tr>
                                <th>Open ORs:</th>
                                <td>@dashboard.BS.OpenORs</td>
                            </tr>
                            <tr>
                                <th>Closed ORs:</th>
                                <td>@dashboard.BS.ClosedORs</td>
                            </tr>
                            <tr>
                                <th>Total Value:</th>
                                <td>@dashboard.BS.TotalORValue.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Invoiced Amount:</th>
                                <td>@dashboard.BS.TotalInvoicedAmount.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Remaining:</th>
                                <td>@dashboard.BS.RemainingAmount.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Paid Invoices:</th>
                                <td>@dashboard.BS.PaidInvoicesTotal.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Unpaid Invoices:</th>
                                <td>@dashboard.BS.UnpaidInvoicesTotal.ToString("C")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DashboardViewModel dashboard = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        isLoading = false;
    }

    private async Task LoadDashboardData()
    {
        // Load OPS metrics using database-level aggregations
        var opsMetrics = await DbContext.ORs
            .Where(o => o.BudgetType == BudgetType.OPS)
            .GroupBy(o => 1)
            .Select(g => new
            {
                TotalORs = g.Count(),
                OpenORs = g.Count(o => o.Status == ORStatus.Open),
                ClosedORs = g.Count(o => o.Status == ORStatus.Closed),
                TotalORValue = g.Sum(o => o.TotalValue)
            })
            .FirstOrDefaultAsync();

        var opsInvoiceMetrics = await DbContext.Invoices
            .Where(i => i.OR.BudgetType == BudgetType.OPS)
            .GroupBy(i => 1)
            .Select(g => new
            {
                TotalInvoicedAmount = g.Sum(i => i.Amount),
                PaidInvoicesTotal = g.Where(i => i.IsPaid == true).Sum(i => i.Amount),
                UnpaidInvoicesTotal = g.Where(i => i.IsPaid != true).Sum(i => i.Amount)
            })
            .FirstOrDefaultAsync();

        dashboard.OPS.TotalORs = opsMetrics?.TotalORs ?? 0;
        dashboard.OPS.OpenORs = opsMetrics?.OpenORs ?? 0;
        dashboard.OPS.ClosedORs = opsMetrics?.ClosedORs ?? 0;
        dashboard.OPS.TotalORValue = opsMetrics?.TotalORValue ?? 0;
        dashboard.OPS.TotalInvoicedAmount = opsInvoiceMetrics?.TotalInvoicedAmount ?? 0;
        dashboard.OPS.RemainingAmount = dashboard.OPS.TotalORValue - dashboard.OPS.TotalInvoicedAmount;
        dashboard.OPS.PaidInvoicesTotal = opsInvoiceMetrics?.PaidInvoicesTotal ?? 0;
        dashboard.OPS.UnpaidInvoicesTotal = opsInvoiceMetrics?.UnpaidInvoicesTotal ?? 0;

        // Load BS metrics using database-level aggregations
        var bsMetrics = await DbContext.ORs
            .Where(o => o.BudgetType == BudgetType.BS)
            .GroupBy(o => 1)
            .Select(g => new
            {
                TotalORs = g.Count(),
                OpenORs = g.Count(o => o.Status == ORStatus.Open),
                ClosedORs = g.Count(o => o.Status == ORStatus.Closed),
                TotalORValue = g.Sum(o => o.TotalValue)
            })
            .FirstOrDefaultAsync();

        var bsInvoiceMetrics = await DbContext.Invoices
            .Where(i => i.OR.BudgetType == BudgetType.BS)
            .GroupBy(i => 1)
            .Select(g => new
            {
                TotalInvoicedAmount = g.Sum(i => i.Amount),
                PaidInvoicesTotal = g.Where(i => i.IsPaid == true).Sum(i => i.Amount),
                UnpaidInvoicesTotal = g.Where(i => i.IsPaid != true).Sum(i => i.Amount)
            })
            .FirstOrDefaultAsync();

        dashboard.BS.TotalORs = bsMetrics?.TotalORs ?? 0;
        dashboard.BS.OpenORs = bsMetrics?.OpenORs ?? 0;
        dashboard.BS.ClosedORs = bsMetrics?.ClosedORs ?? 0;
        dashboard.BS.TotalORValue = bsMetrics?.TotalORValue ?? 0;
        dashboard.BS.TotalInvoicedAmount = bsInvoiceMetrics?.TotalInvoicedAmount ?? 0;
        dashboard.BS.RemainingAmount = dashboard.BS.TotalORValue - dashboard.BS.TotalInvoicedAmount;
        dashboard.BS.PaidInvoicesTotal = bsInvoiceMetrics?.PaidInvoicesTotal ?? 0;
        dashboard.BS.UnpaidInvoicesTotal = bsInvoiceMetrics?.UnpaidInvoicesTotal ?? 0;

        // Calculate totals
        dashboard.Total.TotalORs = dashboard.OPS.TotalORs + dashboard.BS.TotalORs;
        dashboard.Total.OpenORs = dashboard.OPS.OpenORs + dashboard.BS.OpenORs;
        dashboard.Total.ClosedORs = dashboard.OPS.ClosedORs + dashboard.BS.ClosedORs;
        dashboard.Total.TotalORValue = dashboard.OPS.TotalORValue + dashboard.BS.TotalORValue;
        dashboard.Total.TotalInvoicedAmount = dashboard.OPS.TotalInvoicedAmount + dashboard.BS.TotalInvoicedAmount;
        dashboard.Total.RemainingAmount = dashboard.OPS.RemainingAmount + dashboard.BS.RemainingAmount;
        dashboard.Total.PaidInvoicesTotal = dashboard.OPS.PaidInvoicesTotal + dashboard.BS.PaidInvoicesTotal;
        dashboard.Total.UnpaidInvoicesTotal = dashboard.OPS.UnpaidInvoicesTotal + dashboard.BS.UnpaidInvoicesTotal;
    }
}
