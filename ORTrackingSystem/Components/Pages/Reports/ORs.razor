@page "/reports/ors"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using ORTrackingSystem.Data
@using ORTrackingSystem.Models
@using ORTrackingSystem.Models.ViewModels
@attribute [Authorize(Policy = "ViewerOrAdmin")]
@rendermode InteractiveServer

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation

<PageTitle>OR Reports</PageTitle>

<h1>OR Reports</h1>

<div class="card mb-4">
    <div class="card-header">
        <h4>Filters</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Contract Context</label>
                <select class="form-select" @bind="selectedContractContextId" @bind:after="ApplyFilters">
                    <option value="0">-- All --</option>
                    @foreach (var context in contractContexts)
                    {
                        <option value="@context.Id">@context.ContractName</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Budget Type</label>
                <select class="form-select" @bind="selectedBudgetType" @bind:after="ApplyFilters">
                    <option value="">-- All --</option>
                    <option value="OPS">OPS</option>
                    <option value="BS">BS</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="selectedStatus" @bind:after="ApplyFilters">
                    <option value="">-- All --</option>
                    <option value="Open">Open</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" @bind="fromDate" @bind:after="ApplyFilters" />
            </div>
            <div class="col-md-2">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" @bind="toDate" @bind:after="ApplyFilters" />
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-secondary" @onclick="ClearFilters">Clear</button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="archiveFilter" id="allFilter" value="" 
                           checked="@(archiveFilter == "")" @onchange='() => SetArchiveFilter("")'>
                    <label class="btn btn-outline-primary" for="allFilter">All</label>
                    
                    <input type="radio" class="btn-check" name="archiveFilter" id="activeFilter" value="active" 
                           checked="@(archiveFilter == "active")" @onchange='() => SetArchiveFilter("active")'>
                    <label class="btn btn-outline-primary" for="activeFilter">Active Only (Open)</label>
                    
                    <input type="radio" class="btn-check" name="archiveFilter" id="archivedFilter" value="archived" 
                           checked="@(archiveFilter == "archived")" @onchange='() => SetArchiveFilter("archived")'>
                    <label class="btn btn-outline-primary" for="archivedFilter">Archived Only (Closed)</label>
                </div>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>OR Number</th>
                    <th>Contract Name</th>
                    <th>Budget Type</th>
                    <th>Status</th>
                    <th class="text-end">Total Value</th>
                    <th class="text-end">Invoiced Total</th>
                    <th class="text-end">Remaining</th>
                    <th>Created Date</th>
                </tr>
            </thead>
            <tbody>
                @if (orReports.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center">No ORs found matching the filters.</td>
                    </tr>
                }
                else
                {
                    @foreach (var or in orReports)
                    {
                        <tr style="cursor: pointer;" @onclick="() => ViewORDetails(or.Id)">
                            <td>@or.ORNumber</td>
                            <td>@or.ContractName</td>
                            <td>@or.BudgetType</td>
                            <td>
                                <span class="badge @(or.Status == ORStatus.Open ? "bg-success" : "bg-secondary")">
                                    @or.Status
                                </span>
                            </td>
                            <td class="text-end">@or.TotalValue.ToString("C")</td>
                            <td class="text-end">@or.InvoicedTotal.ToString("C")</td>
                            <td class="text-end">@or.Remaining.ToString("C")</td>
                            <td>@or.CreatedDate.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <p><strong>Total Records:</strong> @orReports.Count</p>
    </div>
}

@code {
    private List<ORReportRow> orReports = new();
    private List<ContractContext> contractContexts = new();
    private bool isLoading = true;
    
    // Filters
    private int selectedContractContextId = 0;
    private string selectedBudgetType = "";
    private string selectedStatus = "";
    private DateTime? fromDate;
    private DateTime? toDate;
    private string archiveFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadContractContexts();
        await LoadORReports();
        isLoading = false;
    }

    private async Task LoadContractContexts()
    {
        contractContexts = await DbContext.ContractContexts
            .OrderBy(c => c.ContractName)
            .ToListAsync();
    }

    private async Task LoadORReports()
    {
        var query = DbContext.ORs.AsQueryable();

        // Apply filters
        if (selectedContractContextId > 0)
        {
            query = query.Where(o => o.ContractContextId == selectedContractContextId);
        }

        if (!string.IsNullOrEmpty(selectedBudgetType))
        {
            var budgetType = Enum.Parse<BudgetType>(selectedBudgetType);
            query = query.Where(o => o.BudgetType == budgetType);
        }

        if (!string.IsNullOrEmpty(selectedStatus))
        {
            var status = Enum.Parse<ORStatus>(selectedStatus);
            query = query.Where(o => o.Status == status);
        }

        if (fromDate.HasValue)
        {
            query = query.Where(o => o.CreatedDate >= fromDate.Value);
        }

        if (toDate.HasValue)
        {
            var toDateEnd = toDate.Value.AddDays(1);
            query = query.Where(o => o.CreatedDate < toDateEnd);
        }

        // Archive filter
        if (archiveFilter == "active")
        {
            query = query.Where(o => o.Status == ORStatus.Open);
        }
        else if (archiveFilter == "archived")
        {
            query = query.Where(o => o.Status == ORStatus.Closed);
        }

        orReports = await query
            .Select(o => new ORReportRow
            {
                Id = o.Id,
                ORNumber = o.ORNumber,
                ContractName = o.ContractContext.ContractName,
                BudgetType = o.BudgetType,
                Status = o.Status,
                TotalValue = o.TotalValue,
                InvoicedTotal = o.Invoices.Sum(i => i.Amount),
                Remaining = o.TotalValue - o.Invoices.Sum(i => i.Amount),
                CreatedDate = o.CreatedDate
            })
            .OrderByDescending(o => o.CreatedDate)
            .ToListAsync();
    }

    private async Task ApplyFilters()
    {
        isLoading = true;
        await LoadORReports();
        isLoading = false;
    }

    private async Task SetArchiveFilter(string filter)
    {
        archiveFilter = filter;
        await ApplyFilters();
    }

    private async Task ClearFilters()
    {
        selectedContractContextId = 0;
        selectedBudgetType = "";
        selectedStatus = "";
        fromDate = null;
        toDate = null;
        archiveFilter = "";
        await ApplyFilters();
    }

    private void ViewORDetails(int orId)
    {
        Navigation.NavigateTo($"/reports/ors/{orId}");
    }
}
