@page "/reports/invoices"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using ORTrackingSystem.Data
@using ORTrackingSystem.Models
@using ORTrackingSystem.Models.ViewModels
@attribute [Authorize(Policy = "ViewerOrAdmin")]
@rendermode InteractiveServer

@inject ApplicationDbContext DbContext

<PageTitle>Invoice Reports</PageTitle>

<h1>Invoice Reports</h1>

<div class="card mb-4">
    <div class="card-header">
        <h4>Filters</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Contract Context</label>
                <select class="form-select" @bind="selectedContractContextId" @bind:after="ApplyFilters">
                    <option value="0">-- All --</option>
                    @foreach (var context in contractContexts)
                    {
                        <option value="@context.Id">@context.ContractName</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Budget Type</label>
                <select class="form-select" @bind="selectedBudgetType" @bind:after="ApplyFilters">
                    <option value="">-- All --</option>
                    <option value="OPS">OPS</option>
                    <option value="BS">BS</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Paid Status</label>
                <select class="form-select" @bind="selectedPaidStatus" @bind:after="ApplyFilters">
                    <option value="">-- All --</option>
                    <option value="Paid">Paid</option>
                    <option value="Unpaid">Unpaid</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" @bind="fromDate" @bind:after="ApplyFilters" />
            </div>
            <div class="col-md-2">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" @bind="toDate" @bind:after="ApplyFilters" />
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-secondary" @onclick="ClearFilters">Clear</button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="archiveFilter" id="allFilter" value="" 
                           checked="@(archiveFilter == "")" @onchange='() => SetArchiveFilter("")'>
                    <label class="btn btn-outline-primary" for="allFilter">All</label>
                    
                    <input type="radio" class="btn-check" name="archiveFilter" id="activeFilter" value="active" 
                           checked="@(archiveFilter == "active")" @onchange='() => SetArchiveFilter("active")'>
                    <label class="btn btn-outline-primary" for="activeFilter">Active Only (Unpaid)</label>
                    
                    <input type="radio" class="btn-check" name="archiveFilter" id="archivedFilter" value="archived" 
                           checked="@(archiveFilter == "archived")" @onchange='() => SetArchiveFilter("archived")'>
                    <label class="btn btn-outline-primary" for="archivedFilter">Archived Only (Paid)</label>
                </div>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>OR Number</th>
                    <th>Contract Name</th>
                    <th>Budget Type</th>
                    <th>Invoice Number</th>
                    <th class="text-end">Amount</th>
                    <th>Paid</th>
                    <th>Paid Date</th>
                    <th>Created Date</th>
                </tr>
            </thead>
            <tbody>
                @if (invoiceReports.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center">No invoices found matching the filters.</td>
                    </tr>
                }
                else
                {
                    @foreach (var invoice in invoiceReports)
                    {
                        <tr>
                            <td>@invoice.ORNumber</td>
                            <td>@invoice.ContractName</td>
                            <td>@invoice.BudgetType</td>
                            <td>@invoice.InvoiceNumber</td>
                            <td class="text-end">@invoice.Amount.ToString("C")</td>
                            <td>
                                @if (invoice.IsPaid == true)
                                {
                                    <span class="badge bg-success">Paid</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">Unpaid</span>
                                }
                            </td>
                            <td>@(invoice.PaidDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td>@invoice.CreatedDate.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <p><strong>Total Records:</strong> @invoiceReports.Count</p>
        <p><strong>Total Amount:</strong> @invoiceReports.Sum(i => i.Amount).ToString("C")</p>
    </div>
}

@code {
    private List<InvoiceReportRow> invoiceReports = new();
    private List<ContractContext> contractContexts = new();
    private bool isLoading = true;
    
    // Filters
    private int selectedContractContextId = 0;
    private string selectedBudgetType = "";
    private string selectedPaidStatus = "";
    private DateTime? fromDate;
    private DateTime? toDate;
    private string archiveFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadContractContexts();
        await LoadInvoiceReports();
        isLoading = false;
    }

    private async Task LoadContractContexts()
    {
        contractContexts = await DbContext.ContractContexts
            .OrderBy(c => c.ContractName)
            .ToListAsync();
    }

    private async Task LoadInvoiceReports()
    {
        var query = DbContext.Invoices
            .Include(i => i.OR)
                .ThenInclude(o => o.ContractContext)
            .AsQueryable();

        // Apply filters
        if (selectedContractContextId > 0)
        {
            query = query.Where(i => i.OR.ContractContextId == selectedContractContextId);
        }

        if (!string.IsNullOrEmpty(selectedBudgetType))
        {
            var budgetType = Enum.Parse<BudgetType>(selectedBudgetType);
            query = query.Where(i => i.OR.BudgetType == budgetType);
        }

        if (!string.IsNullOrEmpty(selectedPaidStatus))
        {
            if (selectedPaidStatus == "Paid")
            {
                query = query.Where(i => i.IsPaid == true);
            }
            else if (selectedPaidStatus == "Unpaid")
            {
                query = query.Where(i => i.IsPaid != true);
            }
        }

        if (fromDate.HasValue)
        {
            query = query.Where(i => i.CreatedDate >= fromDate.Value);
        }

        if (toDate.HasValue)
        {
            var toDateEnd = toDate.Value.AddDays(1);
            query = query.Where(i => i.CreatedDate < toDateEnd);
        }

        // Archive filter
        if (archiveFilter == "active")
        {
            query = query.Where(i => i.IsPaid != true);
        }
        else if (archiveFilter == "archived")
        {
            query = query.Where(i => i.IsPaid == true);
        }

        invoiceReports = await query
            .Select(i => new InvoiceReportRow
            {
                ORNumber = i.OR.ORNumber,
                ContractName = i.OR.ContractContext.ContractName,
                BudgetType = i.OR.BudgetType,
                InvoiceNumber = i.InvoiceNumber,
                Amount = i.Amount,
                IsPaid = i.IsPaid,
                PaidDate = i.PaidDate,
                CreatedDate = i.CreatedDate
            })
            .OrderByDescending(i => i.CreatedDate)
            .ToListAsync();
    }

    private async Task ApplyFilters()
    {
        isLoading = true;
        await LoadInvoiceReports();
        isLoading = false;
    }

    private async Task SetArchiveFilter(string filter)
    {
        archiveFilter = filter;
        await ApplyFilters();
    }

    private async Task ClearFilters()
    {
        selectedContractContextId = 0;
        selectedBudgetType = "";
        selectedPaidStatus = "";
        fromDate = null;
        toDate = null;
        archiveFilter = "";
        await ApplyFilters();
    }
}
